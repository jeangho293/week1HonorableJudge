<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8"/>
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
            integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
            crossorigin="anonymous"
    />
    <link href="{{ url_for('static', filename='index.css') }}" rel="stylesheet">

    <!-- JS -->
    <script
            src="https://code.jquery.com/jquery-3.6.0.js"
            integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"
    ></script>

    <!-- 구글폰트 -->
    <link
            href="https://fonts.googleapis.com/css?family=Hahmlet:wght@900&Stylish&display=swap"
            rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.min.js"></script>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.css"
    />

    <title>재판하는 존경장님</title>

</head>

<body>

<div class="container">
    <div class="sign">
        <button onclick="window.location.replace('/login_main')" type="button"
                class="btn btn-secondary loginBtn">로그인
        </button>
        <div class="username">어서오세요, {{ id }} 존경장님
            <button class="logoutBtn btn-sm btn-outline-secondary" type="button" onclick="logout()">로그아웃</button>
        </div>
    </div>
    <div class="title">재판하는 존경장님</div>
    <div class="buttons">
        <button
                type="button"
                class="btn btn-light btn-lg btn-block"
                id="getJudge"
                style="border: 1px solid black"
        >
            재판받기💦
        </button>
        <button
                type="button"
                class="btn btn-dark btn-lg btn-block"
                id="doJudge"
                style="margin-top: 0px"
        >
            재판하기⚖️
        </button>
    </div>
    <!-- 재판하기 리스트 출력 -->
    <div class="list-all">
        <div class="newList">
            <!-- <h3>재판 중</h3> -->
            <ul class="list-group">
                <div id="pagination"></div>
                <div id="demo"></div>
            </ul>
        </div>
        <div class="bests">
            <button
                    type="button"
                    class="btn btn-light btn-lg btn-block"
                    style="border: 1px solid black; cursor: default"
            >
                오늘의 TOP3💢
            </button>
            <button
                    type="button"
                    class="btn btn-primary btn-lg btn-block"
                    style="margin-top: 0px; border: 1px solid black; cursor: default"
            >
                이번 주 TOP3💥
            </button>
        </div>
        <div class="lists">
            <ul class="list-group" id="todayJudge">

            </ul>
            <ul class="list-group" id="weeklyJudge">

            </ul>
        </div>
    </div>
    <!-- 재판받기 리스트 출력 -->
    <div class="post-container">
        <div class="inputs">
            <input class="input-title" placeholder="제목을 입력해주세요"/>
            <textarea
                    class="input-content"
                    placeholder="고민 내용을 입력해주세요"
            ></textarea>
        </div>
        <button style="float: right; margin-bottom: 50px" onclick="post()">재판 접수</button>
    </div>
</div>

<script>
    let postList = null;
    const userId = '{{ id }}';
    const date = new Date().getDate().toString();
    const month = () => {
        let getMonth = (new Date().getMonth() + 1).toString();
        if (getMonth < 10) {
            getMonth = 0 + getMonth;
        }
        return getMonth;
    }
    const year = new Date().getFullYear().toString()
    console.log(date, month(), year)
    let weekStartDate;
    let weekEndDate;

    //로그인 했을 경우
    if (userId) {
        $('.loginBtn').hide()
        $('.username').show()
        $('.logoutBtn').show()
    }

    // 로그아웃
    function logout() {
        $.removeCookie('mytoken', {path: '/'});
        window.location.href = "/"
    }

    //재판하기
    $("#doJudge").click(function () {
        $(".list-all").show();
        $(".post-container").hide();
    });

    // 재판접수
    function post() {
        if (!userId) {
            alert("로그인이 필요합니다!")
            return;
        }
        let title = $(".input-title").val()
        let comment = $(".input-content").val()

        if (!title.trim()) {
            alert('제목을 입력해주세요!')
            return;
        }
        if (!comment.trim()) {
            alert('내용을 입력해주세요!')
            return;
        }

        $.ajax({
            type: "POST",
            url: "/post",
            data: {
                title: title,
                content: comment,
                image: ''
            },
            success: function (response) {
                window.location.reload()
            }
        })
    }

    // 재판받기
    $("#getJudge").click(function () {
        console.log(userId);
        if (!userId) {
            alert("재판을 받기전에 로그인을 해주세요!")
            console.log('실행')
            return;
        }
        $(".list-all").hide();
        $(".post-container").show();
    });

    // 조회수 늘리기
    function onClickPost(id) {
        $.ajax({
            type: 'POST',
            url: '/view',
            data:
                {
                    post_id: id
                },
            success: function (response) {
                {#alert(response)#}
            }
        })
    }

    // 날짜 데이터 변환
    function formatMonth(date) {
        const mymonth = date.getMonth() + 1;
        return mymonth;
    }

    function formatDate(date) {
        const myweekday = date.getDate();
        return myweekday;
    }


    // 글 목록 받아오기
    function getPosts() {

        $("#post-box").empty()
        $.ajax({
            type: "GET",
            url: `/posts`,
            data: {},
            success: function (response) {
                postList = response['posts'];
                console.log(postList)
                console.log(postList[0].postDate)
                console.log(typeof (postList[0].postDate))
                // 페이지네이션
                $("#demo").pagination({
                    pageSize: "7",
                    dataSource: postList.reverse(),
                    callback: function (data, pagination) {
                        let dataHtml = ``;

                        $.each(data, function (index, item) {
                            dataHtml +=
                                `<div id="clickPost">
                                    <a href="/post?post_id=${item['_id']}">
                                    <li
                                      class="
                                        list-group-item
                                        d-flex
                                        justify-content-between
                                        align-items-center
                                      "
                                    >` +
                                ` <p id="allListText">${item["title"]}</p>` +
                                `<span class="badge badge-primary badge-pill">${item["like"]}</span>
                                </li>
                            </a>
                        </div>`;
                            if (!dataHtml) {
                                return;
                            }
                            $("#pagination").html(dataHtml);
                            $("#clickPost").click(() => {
                                onClickPost((item['_id']))
                            })
                        });


                    },
                });

                // 오늘의 격론
                const todayPosts = postList.filter(v => v.postDate.split(' ', 1)[0].split('-')[2] === date && v.postDate.split(' ', 1)[0].split('-')[1] === month() && v.postDate.split(' ', 1)[0].split('-')[0] === year);
                todayPosts.sort((a, b) => b.like - a.like)
                console.log(todayPosts)
                let todayData = ``;

                for (let i = 0; i < todayPosts.length; i++) {
                    if (i > 2) return;
                    todayData +=
                        `<div id="clickPost">
                            <a href="/post?post_id=${todayPosts[i]['_id']}">
                                    <li
                                      class="
                                        list-group-item
                                        d-flex
                                        justify-content-between
                                        align-items-center
                                      "
                                    >` +
                        `<p id="todayText">${todayPosts[i]["title"]}<p>` +
                        `<span class="badge badge-primary badge-pill">${todayPosts[i]["like"]}</span>
                                </li>
                            </a>
                        </div>`;
                    $("#clickPost").click(() => {
                        onClickPost((todayPosts[i]['_id']))
                    })
                    $("#todayJudge").append(todayData)
                }

                // 이번 주 날짜 구하기
                let weekStartDay = 0;
                let weekLastDay = 0;

                function printWeek() {
                    const now = new Date();
                    const nowDayOfWeek = now.getDay();
                    const nowDay = 1;
                    const nowMonth = now.getMonth();
                    let nowYear = now.getYear();
                    nowYear += (nowYear < 2000) ? 1900 : 0;
                    weekStartDate = new Date(nowYear, nowMonth, nowDay - nowDayOfWeek);
                    weekEndDate = new Date(nowYear, nowMonth, nowDay + (6 - nowDayOfWeek));
                    console.log("이번주는 :  " + formatDate(weekStartDate) + " - " + formatDate(weekEndDate));
                    weekStartDay = formatDate(weekStartDate)
                    weekLastDay = formatDate(weekEndDate)

                    console.log(weekStartDay, weekLastDay)
                }

                printWeek()

                // 이번 주의 격론
                const weeklyPosts = postList.filter(v => {
                    console.log(Number(v.postDate.split(' ', 1)[0].split('-')[2]))
                    if (weekStartDay > weekLastDay) {
                        if (v.postDate.split(' ', 1)[0].split('-')[2] > toString(weekStartDay)) {
                            return true;
                        }
                        if (v.postDate.split(' ', 1)[0].split('-')[2] < toString(weekLastDay)) {
                            return true;
                        }
                        return false;
                    }
                    if (toString(weekStartDay) < v.postDate.split(' ', 1)[0].split('-')[2] < toString(weekLastDay)) {
                        return true;
                    }
                    return false;
                });
                weeklyPosts.sort((a, b) => b.like - a.like)
                console.log('d', weeklyPosts)


                let weeklyData = "<div onclick='onClickPost()'>";

                for (let i = 0; i < weeklyPosts.length; i++) {
                    if (i > 2) return;
                    weeklyData +=
                        `<a href="/post?post_id=${weeklyPosts[i]['_id']}">
                                    <li
                                      class="
                                        list-group-item
                                        d-flex
                                        justify-content-between
                                        align-items-center
                                      "
                                    >` +
                        `<p id="todayText">${weeklyPosts[i]["title"]}<p>` +
                        `<span class="badge badge-primary badge-pill">${weeklyPosts[i]["like"]}</span>
                                </li>
                            </a>`;
                }
                weeklyData += "</div>";
                $("#weeklyJudge").append(weeklyData)
            }

        })
    }

    getPosts();


</script>
</body>
</html>
